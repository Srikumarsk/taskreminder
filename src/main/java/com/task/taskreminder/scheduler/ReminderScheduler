package com.task.taskreminder.scheduler;

import com.task.taskreminder.model.Task;
import com.task.taskreminder.repository.TaskRepository;
import com.task.taskreminder.service.EmailService;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import java.time.LocalDate;
import java.util.List;

@Component
public class ReminderScheduler {

    private final TaskRepository taskRepository;
    private final EmailService emailService;

    public ReminderScheduler(TaskRepository taskRepository,
                             EmailService emailService) {
        this.taskRepository = taskRepository;
        this.emailService = emailService;
    }

    // Runs every 1 hour
   // Runs every 2 minutes (Testing)
@Scheduled(fixedRate = 2 * 60 * 1000)
public void sendTaskReminders() {

    System.out.println("âœ… Scheduler Running...");

    LocalDate tomorrow = LocalDate.now().plusDays(1);

    List<Task> tasks = taskRepository
            .findByStatusNotAndDateLessThanEqual("DONE", tomorrow);

    for (Task task : tasks) {

        if (!task.isReminderSent()) {

            String userEmail = task.getUser().getEmail();

            emailService.sendMail(
                    userEmail,
                    "Task Reminder: " + task.getTitle(),
                    "Reminder: Your task \"" + task.getTitle() +
                            "\" is due on " + task.getDate()
            );

            task.setReminderSent(true);
            taskRepository.save(task);

            System.out.println("ðŸ“© Reminder sent for task: " + task.getTitle());
        }
    }
}

}
@Service
public class ReminderScheduler {

    @Autowired
    private TaskRepository taskRepository;

    @Autowired
    private EmailService emailService;

    // Runs every 1 minute for testing
    @Scheduled(fixedRate = 60000)
    public void sendDueTaskReminders() {

        LocalDate today = LocalDate.now();

        List<Task> tasks = taskRepository.findAll();

        for (Task task : tasks) {

            if (task.getDate() != null &&
                task.getDate().isEqual(today.plusDays(1)) &&
                !task.getStatus().equalsIgnoreCase("DONE")) {

                String email = task.getUser().getEmail();

                emailService.sendMail(
                    email,
                    "Task Reminder",
                    "Reminder: Your task '" + task.getTitle() +
                    "' is due tomorrow!"
                );

                System.out.println("Reminder sent for task: " + task.getTitle());
            }
        }
    }
}
